<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipes - Sourdough Bakery</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/auth-service.js"></script>
  <script>
  // Recipe Data Service
  const RecipeDataService = {
    // Recipes storage
    recipes: JSON.parse(localStorage.getItem('sourdough_recipes') || '[]'),
    
    // Save recipes to local storage
    saveRecipes() {
      localStorage.setItem('sourdough_recipes', JSON.stringify(this.recipes));
    },
    
    // Get all recipes
    getAllRecipes() {
      return this.recipes;
    },
    
    // Get recipe by ID
    getRecipeById(id) {
      return this.recipes.find(recipe => recipe.id === id);
    },
    
    // Create a new recipe
    createRecipe(recipeData) {
      const newRecipe = {
        id: Date.now().toString(),
        ...recipeData,
        createdAt: new Date().toISOString(),
        createdBy: AuthService.getCurrentUser().id
      };
      
      this.recipes.push(newRecipe);
      this.saveRecipes();
      
      return newRecipe;
    },
    
    // Update an existing recipe
    updateRecipe(id, recipeData) {
      const index = this.recipes.findIndex(recipe => recipe.id === id);
      
      if (index === -1) {
        throw new Error('Recipe not found');
      }
      
      // Update recipe
      this.recipes[index] = {
        ...this.recipes[index],
        ...recipeData,
        updatedAt: new Date().toISOString()
      };
      
      this.saveRecipes();
      
      return this.recipes[index];
    },
    
    // Delete a recipe
    deleteRecipe(id) {
      const index = this.recipes.findIndex(recipe => recipe.id === id);
      
      if (index === -1) {
        throw new Error('Recipe not found');
      }
      
      // Remove recipe
      this.recipes.splice(index, 1);
      
      this.saveRecipes();
      
      return true;
    },
    
    // Initialize with sample recipes
    initSampleRecipes() {
      // Only initialize if no recipes exist
      if (this.recipes.length === 0) {
        const sampleRecipes = [
          {
            id: '1',
            title: 'Basic Sourdough Loaf',
            difficulty: 'Beginner',
            time: '24 hours',
            ingredients: [
              '500g bread flour',
              '350g water',
              '100g active sourdough starter',
              '10g salt'
            ],
            instructions: [
              'Mix flour and water, let rest for 30 minutes (autolyse).',
              'Add starter and salt, mix thoroughly.',
              'Perform 4-6 stretch and folds over 2-3 hours.',
              'Bulk ferment for 4-6 hours at room temperature.',
              'Shape and place in banneton.',
              'Cold proof in refrigerator for 12-16 hours.',
              'Preheat oven with Dutch oven to 500°F (260°C).',
              'Score and bake covered for 20 minutes.',
              'Reduce temperature to 450°F (230°C) and bake uncovered for 20-25 minutes.'
            ],
            createdAt: new Date().toISOString(),
            createdBy: 'system'
          },
          {
            id: '2',
            title: 'Whole Wheat Sourdough',
            difficulty: 'Intermediate',
            time: '20 hours',
            ingredients: [
              '300g bread flour',
              '200g whole wheat flour',
              '375g water',
              '100g active sourdough starter',
              '10g salt'
            ],
            instructions: [
              'Mix flours and water, let rest for 45 minutes (autolyse).',
              'Add starter and salt, mix thoroughly.',
              'Perform 6 stretch and folds over 3 hours.',
              'Bulk ferment for 3-5 hours at room temperature.',
              'Shape and place in banneton.',
              'Cold proof in refrigerator for 12-14 hours.',
              'Preheat oven with Dutch oven to 500°F (260°C).',
              'Score and bake covered for 20 minutes.',
              'Reduce temperature to 450°F (230°C) and bake uncovered for 20-25 minutes.'
            ],
            createdAt: new Date().toISOString(),
            createdBy: 'system'
          },
          {
            id: '3',
            title: 'Sourdough Baguettes',
            difficulty: 'Advanced',
            time: '26 hours',
            ingredients: [
              '500g bread flour',
              '350g water',
              '100g active sourdough starter',
              '10g salt'
            ],
            instructions: [
              'Mix flour and water, let rest for 1 hour (autolyse).',
              'Add starter and salt, mix thoroughly.',
              'Perform 4 stretch and folds over 2 hours.',
              'Bulk ferment for 4-6 hours at room temperature.',
              'Divide into 3 equal pieces and pre-shape into rectangles.',
              'Rest for 20 minutes, then shape into baguettes.',
              'Proof for 1-2 hours at room temperature.',
              'Cold proof in refrigerator for 12-16 hours.',
              'Preheat oven with baking stone and steam pan to 500°F (260°C).',
              'Score and bake with steam for 10 minutes.',
              'Remove steam, reduce temperature to 450°F (230°C) and bake for 15-20 minutes.'
            ],
            createdAt: new Date().toISOString(),
            createdBy: 'system'
          },
          {
            id: '4',
            title: 'Sourdough Pizza Dough',
            difficulty: 'Beginner',
            time: '12 hours',
            ingredients: [
              '500g bread flour',
              '325g water',
              '100g active sourdough starter',
              '10g salt',
              '15g olive oil'
            ],
            instructions: [
              'Mix flour and water, let rest for 30 minutes (autolyse).',
              'Add starter, salt, and olive oil, mix thoroughly.',
              'Perform 3-4 stretch and folds over 2 hours.',
              'Bulk ferment for 2-3 hours at room temperature.',
              'Divide into 3-4 equal pieces and shape into balls.',
              'Cold proof in refrigerator for 8-24 hours.',
              'Remove from refrigerator 1-2 hours before using.',
              'Stretch or roll into pizza shape.',
              'Add toppings and bake at highest oven temperature (preferably on a pizza stone).'
            ],
            createdAt: new Date().toISOString(),
            createdBy: 'system'
          }
        ];
        
        this.recipes = sampleRecipes;
        this.saveRecipes();
        
        console.log('Sample recipes created');
      }
    }
  };

  // Initialize sample recipes
  RecipeDataService.initSampleRecipes();
  </script>
</head>
<body>
  <header>
    <h1>Sourdough Bakery Web App</h1>
  </header>
  
  <nav>
    <ul>
      <li><a href="/dashboard.html">Dashboard</a></li>
      <li><a href="/recipes.html">Recipes</a></li>
      <li><a href="/tasks.html">Tasks</a></li>
      <li><a href="/starters.html">Starters</a></li>
      <li><a href="/timers.html">Timers</a></li>
      <li><a href="/profile.html">Profile</a></li>
      <li id="admin-link" style="display: none;"><a href="/admin.html">Admin Panel</a></li>
    </ul>
  </nav>
  
  <div class="container">
    <div class="card">
      <h2>Recipes</h2>
      <div id="recipe-controls">
        <button id="add-recipe-btn" class="btn" style="display: none;">Add New Recipe</button>
      </div>
    </div>
    
    <div class="dashboard-grid">
      <!-- Recipes will be loaded here dynamically -->
    </div>
  </div>

  <!-- Recipe View Modal -->
  <div id="recipe-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="background-color: white; margin: 10% auto; padding: 20px; width: 80%; max-width: 700px; border-radius: 8px;">
      <h2 id="modal-recipe-title">Recipe Title</h2>
      <div id="modal-recipe-content">
        <!-- Recipe content will be inserted here -->
      </div>
      <button id="close-modal-btn" class="btn btn-secondary" style="margin-top: 20px;">Close</button>
    </div>
  </div>

  <!-- Add/Edit Recipe Modal -->
  <div id="recipe-form-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="background-color: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 700px; border-radius: 8px;">
      <h2 id="recipe-form-title">Add New Recipe</h2>
      <form id="recipe-form">
        <input type="hidden" id="recipe-id">
        <div class="form-group">
          <label for="recipe-title">Recipe Title</label>
          <input type="text" id="recipe-title" required>
        </div>
        <div class="form-group">
          <label for="recipe-difficulty">Difficulty</label>
          <select id="recipe-difficulty" required>
            <option value="Beginner">Beginner</option>
            <option value="Intermediate">Intermediate</option>
            <option value="Advanced">Advanced</option>
          </select>
        </div>
        <div class="form-group">
          <label for="recipe-time">Total Time (including fermentation)</label>
          <input type="text" id="recipe-time" placeholder="e.g., 24 hours" required>
        </div>
        <div class="form-group">
          <label for="recipe-ingredients">Ingredients (one per line)</label>
          <textarea id="recipe-ingredients" rows="6" required></textarea>
        </div>
        <div class="form-group">
          <label for="recipe-instructions">Instructions (one step per line)</label>
          <textarea id="recipe-instructions" rows="10" required></textarea>
        </div>
        <button type="submit" class="btn">Save Recipe</button>
        <button type="button" id="cancel-recipe-btn" class="btn btn-secondary">Cancel</button>
      </form>
    </div>
  </div>

  <script>
    // Check if user is signed in
    if (!AuthService.isSignedIn()) {
      window.location.href = '/index.html';
    }
    
    // Get current user
    const currentUser = AuthService.getCurrentUser();
    
    // Show admin link if user is admin
    if (currentUser.role === 'admin') {
      document.getElementById('admin-link').style.display = 'block';
    }
    
    // Show edit buttons and add recipe button based on permissions
    if (AuthService.hasPermission('manage_recipes')) {
      document.getElementById('add-recipe-btn').style.display = 'inline-block';
    }
    
    // Load recipes
    function loadRecipes() {
      const recipes = RecipeDataService.getAllRecipes();
      const container = document.querySelector('.dashboard-grid');
      
      // Clear container
      container.innerHTML = '';
      
      // Add recipes to container
      recipes.forEach(recipe => {
        const recipeCard = document.createElement('div');
        recipeCard.className = 'dashboard-card';
        
        recipeCard.innerHTML = `
          <h3>${recipe.title}</h3>
          <p><strong>Difficulty:</strong> ${recipe.difficulty}</p>
          <p><strong>Time:</strong> ${recipe.time}</p>
          <button class="btn view-recipe-btn" data-id="${recipe.id}">View Recipe</button>
          ${AuthService.hasPermission('manage_recipes') ? 
            `<button class="btn edit-recipe-btn" data-id="${recipe.id}">Edit Recipe</button>
             <button class="btn btn-secondary delete-recipe-btn" data-id="${recipe.id}">Delete</button>` : ''}
        `;
        
        container.appendChild(recipeCard);
      });
      
      // Add event listeners
      document.querySelectorAll('.view-recipe-btn').forEach(btn => {
        btn.addEventListener('click', () => viewRecipe(btn.getAttribute('data-id')));
      });
      
      document.querySelectorAll('.edit-recipe-btn').forEach(btn => {
        btn.addEventListener('click', () => editRecipe(btn.getAttribute('data-id')));
      });
      
      document.querySelectorAll('.delete-recipe-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteRecipe(btn.getAttribute('data-id')));
      });
    }
    
    // View recipe
    function viewRecipe(recipeId) {
      const recipe = RecipeDataService.getRecipeById(recipeId);
      
      // Set modal title
      document.getElementById('modal-recipe-title').textContent = recipe.title;
      
      // Build recipe content
      let content = `
        <p><strong>Difficulty:</strong> ${recipe.difficulty}</p>
        <p><strong>Time:</strong> ${recipe.time}</p>
        <h3>Ingredients</h3>
        <ul>
          ${recipe.ingredients.map(item => `<li>${item}</li>`).join('')}
        </ul>
        <h3>Instructions</h3>
        <ol>
          ${recipe.instructions.map(item => `<li>${item}</li>`).join('')}
        </ol>
      `;
      
      // Set modal content
      document.getElementById('modal-recipe-content').innerHTML = content;
      
      // Show modal
      document.getElementById('recipe-modal').style.display = 'block';
    }
    
    // Add recipe
    function addRecipe() {
      // Reset form
      document.getElementById('recipe-form').reset();
      document.getElementById('recipe-id').value = '';
      
      // Set form title
      document.getElementById('recipe-form-title').textContent = 'Add New Recipe';
      
      // Show modal
      document.getElementById('recipe-form-modal').style.display = 'block';
    }
    
    // Edit recipe
    function editRecipe(recipeId) {
      const recipe = RecipeDataService.getRecipeById(recipeId);
      
      // Set form values
      document.getElementById('recipe-id').value = recipe.id;
      document.getElementById('recipe-title').value = recipe.title;
      document.getElementById('recipe-difficulty').value = recipe.difficulty;
      document.getElementById('recipe-time').value = recipe.time;
      document.getElementById('recipe-ingredients').value = recipe.ingredients.join('\n');
      document.getElementById('recipe-instructions').value = recipe.instructions.join('\n');
      
      // Set form title
      document.getElementById('recipe-form-title').textContent = 'Edit Recipe';
      
      // Show modal
      document.getElementById('recipe-form-modal').style.display = 'block';
    }
    
    // Delete recipe
    function deleteRecipe(recipeId) {
      if (confirm('Are you sure you want to delete this recipe?')) {
        RecipeDataService.deleteRecipe(recipeId);
        loadRecipes();
      }
    }
    
    // Close recipe view modal
    document.getElementById('close-modal-btn').addEventListener('click', () => {
      document.getElementById('recipe-modal').style.display = 'none';
    });
    
    // Add recipe button
    document.getElementById('add-recipe-btn').addEventListener('click', addRecipe);
    
    // Cancel recipe form button
    document.getElementById('cancel-recipe-btn').addEventListener('click', () => {
      document.getElementById('recipe-form-modal').style.display = 'none';
    });
    
    // Recipe form submission
    document.getElementById('recipe-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const recipeId = document.getElementById('recipe-id').value;
      const recipeData = {
        title: document.getElementById('recipe-title').value,
        difficulty: document.getElementById('recipe-difficulty').value,
        time: document.getElementById('recipe-time').value,
        ingredients: document.getElementById('recipe-ingredients').value.split('\n').filter(line => line.trim() !== ''),
        instructions: document.getElementById('recipe-instructions').value.split('\n').filter(line => line.trim() !== '')
      };
      
      if (recipeId) {
        // Update existing recipe
        RecipeDataService.updateRecipe(recipeId, recipeData);
      } else {
        // Create new recipe
        RecipeDataService.createRecipe(recipeData);
      }
      
      // Close modal
      document.getElementById('recipe-form-modal').style.display = 'none';
      
      // Reload recipes
      loadRecipes();
    });
    
    // Load recipes on page load
    loadRecipes();
  </script>
</body>
</html>
