<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Recipes - Sourdough Bakery</title>
  <link rel="stylesheet" href="/css/styles.css">
  <script src="/js/auth-service.js"></script>
  <script src="/js/unit-converter.js"></script>
  <style>
    /* Existing styles remain the same */
    .recipe-scaling {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .loaf-calculator {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .unit-conversion {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .recipe-tag {
      display: inline-block;
      padding: 3px 8px;
      margin-right: 5px;
      margin-bottom: 5px;
      border-radius: 12px;
      font-size: 12px;
      background-color: #e9ecef;
    }
    
    .recipe-category {
      display: inline-block;
      padding: 3px 8px;
      margin-right: 5px;
      margin-bottom: 5px;
      border-radius: 4px;
      font-size: 12px;
      background-color: #4C7A4C;
      color: white;
    }
    
    .scale-input {
      width: 80px;
      text-align: center;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .loaf-input {
      width: 80px;
      text-align: center;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      font-size: 16px;
    }
    
    .loaf-result {
      font-weight: bold;
      font-size: 18px;
      color: #4C7A4C;
      margin-top: 10px;
    }
    
    .ingredient-select-container {
      position: relative;
      margin-bottom: 10px;
    }
    
    .ingredient-select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .ingredient-dropdown {
      position: absolute;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background-color: white;
      border: 1px solid #ced4da;
      border-radius: 0 0 4px 4px;
      z-index: 10;
      display: none;
    }
    
    .ingredient-dropdown-item {
      padding: 8px;
      cursor: pointer;
    }
    
    .ingredient-dropdown-item:hover {
      background-color: #f8f9fa;
    }
    
    .ingredient-quantity {
      width: 80px;
      text-align: center;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .ingredient-unit {
      width: 80px;
      text-align: center;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
    }
    
    .nutrition-summary {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .nutrition-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    
    .nutrition-table th, .nutrition-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #dee2e6;
    }
    
    .csv-upload {
      margin-top: 20px;
      padding: 15px;
      background-color: #f8f9fa;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }
    
    .upload-result {
      margin-top: 10px;
      padding: 10px;
      border-radius: 4px;
    }
    
    .upload-success {
      background-color: #d4edda;
      color: #155724;
    }
    
    .upload-error {
      background-color: #f8d7da;
      color: #721c24;
    }
    
    .recipe-tags-container {
      margin-top: 15px;
    }
    
    .tag-input {
      width: 150px;
      padding: 5px;
      border: 1px solid #ced4da;
      border-radius: 4px;
      margin-right: 5px;
    }
    
    /* New styles for duplicate confirmation */
    .duplicate-confirmation {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.7);
      z-index: 2000;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    
    .duplicate-confirmation-content {
      background-color: white;
      padding: 20px;
      border-radius: 8px;
      width: 80%;
      max-width: 600px;
      max-height: 80vh;
      overflow-y: auto;
    }
    
    .duplicate-item {
      border: 1px solid #dee2e6;
      padding: 10px;
      margin-bottom: 10px;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <header>
    <h1>Sourdough Bakery Web App</h1>
  </header>
  
  <nav>
    <ul>
      <li><a href="/dashboard.html">Dashboard</a></li>
      <li><a href="/recipes.html">Recipes</a></li>
      <li><a href="/tasks.html">Tasks</a></li>
      <li><a href="/starters.html">Starters</a></li>
      <li><a href="/timers.html">Timers</a></li>
      <li><a href="/ingredients.html">Ingredients</a></li>
      <li><a href="/profile.html">Profile</a></li>
      <li id="admin-link" style="display: none;"><a href="/admin.html">Admin Panel</a></li>
    </ul>
  </nav>
  
  <div class="container">
    <div class="card">
      <h2>Recipes</h2>
      <div id="recipe-controls">
        <button id="add-recipe-btn" class="btn" style="display: none;">Add New Recipe</button>
      </div>
    </div>
    
    <!-- CSV Upload Section -->
    <div class="csv-upload">
      <h3>Import Recipes from CSV</h3>
      <p>Upload your recipes CSV file to import all data at once.</p>
      <div style="display: flex; gap: 10px; align-items: center;">
        <input type="file" id="csv-file-input" accept=".csv" style="flex-grow: 1;">
        <button id="upload-csv-btn" class="btn">Upload</button>
      </div>
      <div id="upload-result" class="upload-result" style="display: none;"></div>
    </div>
    
    <div id="recipes-container">
      <!-- Recipes will be loaded here dynamically -->
    </div>
  </div>

  <!-- Recipe Detail Modal -->
  <div id="recipe-detail-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="background-color: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px;">
      <h2 id="recipe-detail-title">Recipe Details</h2>
      
      <div id="recipe-detail-content">
        <!-- Recipe details will be loaded here dynamically -->
      </div>
      
      <div class="recipe-scaling">
        <h3>Recipe Scaling</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
          <button id="scale-down-btn" class="btn">-</button>
          <input type="number" id="scale-factor-input" class="scale-input" value="1.0" min="0.1" step="0.1">
          <button id="scale-up-btn" class="btn">+</button>
          <button id="apply-scale-btn" class="btn">Apply</button>
          <button id="reset-scale-btn" class="btn btn-secondary">Reset</button>
        </div>
      </div>
      
      <div class="loaf-calculator">
        <h3>Loaf Calculator</h3>
        <div style="display: flex; align-items: center; gap: 10px;">
          <label for="loaf-weight-input">Target weight per loaf (g):</label>
          <input type="number" id="loaf-weight-input" class="loaf-input" value="500" min="100" step="10">
          <button id="calculate-loaves-btn" class="btn">Calculate</button>
        </div>
        <div id="loaf-result" class="loaf-result"></div>
      </div>
      
      <div class="unit-conversion">
        <h3>Unit Conversion</h3>
        <div style="display: flex; gap: 10px;">
          <button id="convert-metric-btn" class="btn">Metric (g, ml)</button>
          <button id="convert-imperial-btn" class="btn">Imperial (oz, cups)</button>
        </div>
      </div>
      
      <div class="nutrition-summary">
        <h3>Nutrition Summary</h3>
        <table class="nutrition-table">
          <tr>
            <th>Total Weight</th>
            <th>Calories</th>
            <th>Protein</th>
            <th>Carbs</th>
            <th>Fat</th>
            <th>Cost</th>
          </tr>
          <tr>
            <td id="total-weight">0g</td>
            <td id="total-calories">0 kcal</td>
            <td id="total-protein">0g</td>
            <td id="total-carbs">0g</td>
            <td id="total-fat">0g</td>
            <td id="total-cost">0.000 KD</td>
          </tr>
        </table>
      </div>
      
      <button type="button" id="close-detail-btn" class="btn btn-secondary" style="margin-top: 20px;">Close</button>
    </div>
  </div>

  <!-- Add/Edit Recipe Modal -->
  <div id="recipe-form-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="background-color: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px;">
      <h2 id="recipe-form-title">Add New Recipe</h2>
      <form id="recipe-form">
        <input type="hidden" id="recipe-id">
        
        <div class="form-group">
          <label for="recipe-title">Recipe Title</label>
          <input type="text" id="recipe-title" required>
        </div>
        
        <div class="form-group">
          <label for="recipe-category">Category</label>
          <select id="recipe-category" required>
            <option value="">Select a category</option>
            <option value="bread">Bread</option>
            <option value="bagel">Bagel</option>
            <option value="bun">Bun</option>
            <option value="pastry">Pastry</option>
            <option value="dessert">Dessert</option>
            <option value="sandwich">Sandwich</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="recipe-difficulty">Difficulty</label>
          <select id="recipe-difficulty" required>
            <option value="">Select difficulty</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </div>
        
        <div class="form-group">
          <label for="recipe-time">Preparation Time (minutes)</label>
          <input type="number" id="recipe-time" required min="1">
        </div>
        
        <div class="recipe-tags-container">
          <label>Tags</label>
          <div style="display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 10px;" id="tags-container">
            <!-- Tags will be added here dynamically -->
          </div>
          <div style="display: flex; gap: 5px;">
            <input type="text" id="tag-input" class="tag-input" placeholder="Add a tag">
            <button type="button" id="add-tag-btn" class="btn">Add Tag</button>
          </div>
        </div>
        
        <h3>Ingredients</h3>
        <div id="ingredients-container">
          <!-- Ingredient rows will be added here dynamically -->
          <div class="ingredient-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <div class="ingredient-select-container" style="flex-grow: 1;">
              <input type="text" class="ingredient-select" placeholder="Search for an ingredient...">
              <div class="ingredient-dropdown"></div>
            </div>
            <input type="number" class="ingredient-quantity" placeholder="Qty" min="0" step="0.1">
            <select class="ingredient-unit">
              <option value="gram">gram</option>
              <option value="ml">ml</option>
              <option value="pcs">pcs</option>
              <option value="tbsp">tbsp</option>
              <option value="tsp">tsp</option>
            </select>
            <button type="button" class="btn btn-secondary remove-ingredient-btn">Remove</button>
          </div>
        </div>
        <button type="button" id="add-ingredient-row-btn" class="btn" style="margin-top: 10px;">Add Ingredient</button>
        
        <div class="form-group" style="margin-top: 20px;">
          <label for="recipe-instructions">Instructions</label>
          <textarea id="recipe-instructions" rows="6" required></textarea>
        </div>
        
        <div class="nutrition-summary" style="margin-top: 20px;">
          <h3>Calculated Nutrition Facts</h3>
          <table class="nutrition-table">
            <tr>
              <th>Total Weight</th>
              <th>Calories</th>
              <th>Protein</th>
              <th>Carbs</th>
              <th>Fat</th>
              <th>Cost</th>
            </tr>
            <tr>
              <td id="form-total-weight">0g</td>
              <td id="form-total-calories">0 kcal</td>
              <td id="form-total-protein">0g</td>
              <td id="form-total-carbs">0g</td>
              <td id="form-total-fat">0g</td>
              <td id="form-total-cost">0.000 KD</td>
            </tr>
          </table>
        </div>
        
        <div style="margin-top: 20px;">
          <button type="submit" class="btn">Save Recipe</button>
          <button type="button" id="cancel-recipe-btn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Create Composite Recipe Modal -->
  <div id="composite-recipe-modal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.7); z-index: 1000; overflow-y: auto;">
    <div style="background-color: white; margin: 5% auto; padding: 20px; width: 80%; max-width: 800px; border-radius: 8px;">
      <h2>Create Composite Recipe</h2>
      <p>Combine existing recipes to create a new composite recipe (e.g., sandwich, meal).</p>
      
      <form id="composite-recipe-form">
        <div class="form-group">
          <label for="composite-recipe-title">Recipe Title</label>
          <input type="text" id="composite-recipe-title" required>
        </div>
        
        <div class="form-group">
          <label for="composite-recipe-category">Category</label>
          <select id="composite-recipe-category" required>
            <option value="">Select a category</option>
            <option value="sandwich">Sandwich</option>
            <option value="meal">Meal</option>
            <option value="platter">Platter</option>
            <option value="other">Other</option>
          </select>
        </div>
        
        <h3>Component Recipes</h3>
        <div id="component-recipes-container">
          <!-- Component recipe rows will be added here dynamically -->
          <div class="component-recipe-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <select class="component-recipe-select" style="flex-grow: 1;">
              <option value="">Select a recipe...</option>
              <!-- Recipe options will be added here dynamically -->
            </select>
            <input type="number" class="component-recipe-quantity" placeholder="Qty" min="1" value="1">
            <button type="button" class="btn btn-secondary remove-component-btn">Remove</button>
          </div>
        </div>
        <button type="button" id="add-component-btn" class="btn" style="margin-top: 10px;">Add Component</button>
        
        <h3>Additional Ingredients</h3>
        <div id="composite-ingredients-container">
          <!-- Ingredient rows will be added here dynamically -->
          <div class="ingredient-row" style="display: flex; gap: 10px; margin-bottom: 10px; align-items: center;">
            <div class="ingredient-select-container" style="flex-grow: 1;">
              <input type="text" class="ingredient-select" placeholder="Search for an ingredient...">
              <div class="ingredient-dropdown"></div>
            </div>
            <input type="number" class="ingredient-quantity" placeholder="Qty" min="0" step="0.1">
            <select class="ingredient-unit">
              <option value="gram">gram</option>
              <option value="ml">ml</option>
              <option value="pcs">pcs</option>
              <option value="tbsp">tbsp</option>
              <option value="tsp">tsp</option>
            </select>
            <button type="button" class="btn btn-secondary remove-ingredient-btn">Remove</button>
          </div>
        </div>
        <button type="button" id="add-composite-ingredient-btn" class="btn" style="margin-top: 10px;">Add Ingredient</button>
        
        <div class="form-group" style="margin-top: 20px;">
          <label for="composite-recipe-instructions">Assembly Instructions</label>
          <textarea id="composite-recipe-instructions" rows="6" required></textarea>
        </div>
        
        <div class="nutrition-summary" style="margin-top: 20px;">
          <h3>Calculated Nutrition Facts</h3>
          <table class="nutrition-table">
            <tr>
              <th>Total Weight</th>
              <th>Calories</th>
              <th>Protein</th>
              <th>Carbs</th>
              <th>Fat</th>
              <th>Cost</th>
            </tr>
            <tr>
              <td id="composite-total-weight">0g</td>
              <td id="composite-total-calories">0 kcal</td>
              <td id="composite-total-protein">0g</td>
              <td id="composite-total-carbs">0g</td>
              <td id="composite-total-fat">0g</td>
              <td id="composite-total-cost">0.000 KD</td>
            </tr>
          </table>
        </div>
        
        <div style="margin-top: 20px;">
          <button type="submit" class="btn">Save Composite Recipe</button>
          <button type="button" id="cancel-composite-btn" class="btn btn-secondary">Cancel</button>
        </div>
      </form>
    </div>
  </div>
  
  <!-- Duplicate Confirmation Modal -->
  <div id="duplicate-confirmation-modal" style="display: none;" class="duplicate-confirmation">
    <div class="duplicate-confirmation-content">
      <h2>Duplicate Recipes Found</h2>
      <p>The following recipes already exist. Would you like to replace them?</p>
      
      <div id="duplicate-list">
        <!-- Duplicate items will be added here dynamically -->
      </div>
      
      <div style="margin-top: 20px; display: flex; gap: 10px; justify-content: flex-end;">
        <button id="replace-all-btn" class="btn">Replace All</button>
        <button id="keep-all-btn" class="btn">Keep Existing</button>
        <button id="cancel-import-btn" class="btn btn-secondary">Cancel Import</button>
      </div>
    </div>
  </div>

  <script>
    // Check if user is signed in
    if (!AuthService.isSignedIn()) {
      window.location.href = '/index.html';
    }
    
    // Get current user
    const currentUser = AuthService.getCurrentUser();
    
    // Show admin link if user is admin
    if (currentUser.role === 'admin') {
      document.getElementById('admin-link').style.display = 'block';
    }
    
    // Show add recipe button based on permissions
    if (AuthService.hasPermission('manage_recipes')) {
      document.getElementById('add-recipe-btn').style.display = 'inline-block';
    }
    
    // Recipe Data Service
    const RecipeDataService = {
      // Recipes storage
      recipes: JSON.parse(localStorage.getItem('sourdough_recipes') || '[]'),
      
      // Tags storage
      tags: JSON.parse(localStorage.getItem('sourdough_recipe_tags') || '[]'),
      
      // Save recipes to local storage
      saveRecipes() {
        localStorage.setItem('sourdough_recipes', JSON.stringify(this.recipes));
      },
      
      // Save tags to local storage
      saveTags() {
        localStorage.setItem('sourdough_recipe_tags', JSON.stringify(this.tags));
      },
      
      // Get all recipes
      getAllRecipes() {
        return this.recipes;
      },
      
      // Get recipe by ID
      getRecipeById(id) {
        return this.recipes.find(recipe => recipe.id === id);
      },
      
      // Get recipes by tag
      getRecipesByTag(tag) {
        return this.recipes.filter(recipe => 
          recipe.tags && recipe.tags.includes(tag)
        );
      },
      
      // Create a new recipe
      createRecipe(recipeData) {
        const newRecipe = {
          id: Date.now().toString(),
          ...recipeData,
          createdAt: new Date().toISOString(),
          createdBy: AuthService.getCurrentUser().id
        };
        
        this.recipes.push(newRecipe);
        this.saveRecipes();
        
        // Add new tags if they don't exist
        if (recipeData.tags && recipeData.tags.length > 0) {
          recipeData.tags.forEach(tag => {
            if (!this.tags.includes(tag)) {
              this.tags.push(tag);
            }
          });
          this.saveTags();
        }
        
        return newRecipe;
      },
      
      // Update an existing recipe
      updateRecipe(id, recipeData) {
        const index = this.recipes.findIndex(recipe => recipe.id === id);
        
        if (index === -1) {
          throw new Error('Recipe not found');
        }
        
        // Update recipe
        this.recipes[index] = {
          ...this.recipes[index],
          ...recipeData,
          updatedAt: new Date().toISOString()
        };
        
        this.saveRecipes();
        
        // Add new tags if they don't exist
        if (recipeData.tags && recipeData.tags.length > 0) {
          recipeData.tags.forEach(tag => {
            if (!this.tags.includes(tag)) {
              this.tags.push(tag);
            }
          });
          this.saveTags();
        }
        
        return this.recipes[index];
      },
      
      // Delete a recipe
      deleteRecipe(id) {
        const index = this.recipes.findIndex(recipe => recipe.id === id);
        
        if (index === -1) {
          throw new Error('Recipe not found');
        }
        
        // Remove recipe
        this.recipes.splice(index, 1);
        
        this.saveRecipes();
        
        return true;
      },
      
      // Import recipes from CSV with improved ingredient matching
      importRecipesFromCSV(csvData) {
        try {
          // Parse CSV data
          const lines = csvData.split('\n');
          
          let currentRecipe = null;
          const recipes = [];
          const duplicates = [];
          
          for (let i = 0; i < lines.length; i++) {
            const line = lines[i].trim();
            if (!line) continue;
            
            const cells = line.split(',');
            
            // Check if this is a new recipe header
            if (cells[0] && cells[1] && !cells[0].includes('Total') && !cells[0].includes('Nutrition')) {
              // If we have a current recipe, save it before starting a new one
              if (currentRecipe && currentRecipe.ingredients.length > 0) {
                // Check for duplicates
                const existingRecipe = this.recipes.find(r => 
                  r.title.toLowerCase() === currentRecipe.title.toLowerCase()
                );
                
                if (existingRecipe) {
                  duplicates.push({
                    existing: existingRecipe,
                    new: currentRecipe
                  });
                } else {
                  recipes.push(currentRecipe);
                }
              }
              
              // Start a new recipe
              currentRecipe = {
                id: Date.now().toString() + recipes.length,
                title: cells[1].trim(),
                category: this.determineCategoryFromTitle(cells[1].trim()),
                difficulty: 'medium',
                time: 60,
                ingredients: [],
                instructions: 'Imported from CSV',
                tags: [],
                nutritionFacts: {
                  weight: 0,
                  calories: 0,
                  protein: 0,
                  carbs: 0,
                  fat: 0
                },
                totalCost: 0,
                createdAt: new Date().toISOString(),
                createdBy: AuthService.getCurrentUser().id
              };
            }
            // Check if this is an ingredient line
            else if (currentRecipe && cells[1] && cells[2] && !cells[0].includes('Total') && !cells[0].includes('Nutrition')) {
              const ingredientName = cells[2].trim();
              const quantity = parseFloat(cells[3].replace(/,/g, '')) || 0;
              const unit = cells[4].trim() || 'gram';
              
              // Add ingredient to current recipe
              currentRecipe.ingredients.push({
                name: ingredientName,
                quantity: quantity,
                unit: unit,
                cost: 0 // Will be calculated later
              });
            }
            // Check if this is a nutrition fact line
            else if (currentRecipe && cells[0].includes('Total Weight')) {
              if (cells[2]) {
                currentRecipe.nutritionFacts.weight = parseFloat(cells[2].replace(/,/g, '')) || 0;
              }
            }
            else if (currentRecipe && cells[0].includes('Calories')) {
              if (cells[2]) {
                currentRecipe.nutritionFacts.calories = parseFloat(cells[2].replace(/,/g, '')) || 0;
              }
            }
            else if (currentRecipe && cells[0].includes('Protein')) {
              if (cells[2]) {
                currentRecipe.nutritionFacts.protein = parseFloat(cells[2].replace(/,/g, '')) || 0;
              }
            }
            else if (currentRecipe && cells[0].includes('Carbs')) {
              if (cells[2]) {
                currentRecipe.nutritionFacts.carbs = parseFloat(cells[2].replace(/,/g, '')) || 0;
              }
            }
            else if (currentRecipe && cells[0].includes('Fat')) {
              if (cells[2]) {
                currentRecipe.nutritionFacts.fat = parseFloat(cells[2].replace(/,/g, '')) || 0;
              }
            }
          }
          
          // Add the last recipe if it exists
          if (currentRecipe && currentRecipe.ingredients.length > 0) {
            // Check for duplicates
            const existingRecipe = this.recipes.find(r => 
              r.title.toLowerCase() === currentRecipe.title.toLowerCase()
            );
            
            if (existingRecipe) {
              duplicates.push({
                existing: existingRecipe,
                new: currentRecipe
              });
            } else {
              recipes.push(currentRecipe);
            }
          }
          
          // Process each recipe to update nutrition facts from ingredients database
          recipes.forEach(recipe => {
            updateRecipeNutritionFromIngredients(recipe);
          });
          
          duplicates.forEach(dup => {
            updateRecipeNutritionFromIngredients(dup.new);
          });
          
          // Handle duplicates if any
          if (duplicates.length > 0) {
            return {
              success: true,
              count: recipes.length,
              duplicates: duplicates,
              recipes: recipes,
              message: `Successfully processed ${recipes.length} recipes. Found ${duplicates.length} duplicates that need confirmation.`
            };
          } else {
            // Add all recipes to storage
            this.recipes = [...this.recipes, ...recipes];
            this.saveRecipes();
            
            return {
              success: true,
              count: recipes.length,
              message: `Successfully imported ${recipes.length} recipes.`
            };
          }
        } catch (error) {
          console.error('Error importing CSV:', error);
          return {
            success: false,
            message: `Error importing CSV: ${error.message}`
          };
        }
      },
      
      // Determine category from recipe title
      determineCategoryFromTitle(title) {
        title = title.toLowerCase();
        if (title.includes('bagel')) return 'bagel';
        if (title.includes('loaf') || title.includes('bread') || title.includes('sourdough')) return 'bread';
        if (title.includes('bun') || title.includes('roll') || title.includes('brioche')) return 'bun';
        if (title.includes('babka') || title.includes('pastry')) return 'pastry';
        if (title.includes('brownie') || title.includes('dessert')) return 'dessert';
        if (title.includes('sandwich')) return 'sandwich';
        return 'other';
      }
    };
    
    // Get ingredients from local storage
    function getIngredients() {
      return JSON.parse(localStorage.getItem('sourdough_ingredients') || '[]');
    }
    
    // Update recipe nutrition facts based on ingredients database
    function updateRecipeNutritionFromIngredients(recipe) {
      const allIngredients = getIngredients();
      let totalWeight = 0;
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      let totalCost = 0;
      
      recipe.ingredients.forEach(ingredient => {
        // Find the ingredient in the database
        const ingredientData = allIngredients.find(i => 
          i.name.toLowerCase() === ingredient.name.toLowerCase()
        );
        
        if (ingredientData) {
          // Convert to grams if needed
          let weightInGrams = ingredient.quantity;
          if (ingredient.unit === 'ml') {
            // Assume 1ml = 1g for simplicity
            weightInGrams = ingredient.quantity;
          } else if (ingredient.unit === 'pcs') {
            // Use package size as weight per piece
            weightInGrams = ingredient.quantity * ingredientData.packageSize;
          } else if (ingredient.unit === 'tbsp') {
            // Approximate conversion: 1 tbsp = 15g
            weightInGrams = ingredient.quantity * 15;
          } else if (ingredient.unit === 'tsp') {
            // Approximate conversion: 1 tsp = 5g
            weightInGrams = ingredient.quantity * 5;
          }
          
          totalWeight += weightInGrams;
          
          // Calculate nutrition based on 100g values
          const ratio = weightInGrams / 100;
          totalCalories += (ingredientData.calories || 0) * ratio;
          totalProtein += (ingredientData.protein || 0) * ratio;
          totalCarbs += (ingredientData.carbs || 0) * ratio;
          totalFat += (ingredientData.fat || 0) * ratio;
          
          // Update cost from database
          ingredient.cost = ingredientData.pricePerUnit * ingredient.quantity;
          totalCost += ingredient.cost;
        } else {
          // If ingredient not in database, use existing values
          totalWeight += ingredient.quantity;
          totalCost += ingredient.cost || 0;
        }
      });
      
      // Update recipe nutrition facts
      recipe.nutritionFacts = {
        weight: totalWeight,
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat
      };
      
      // Update total cost
      recipe.totalCost = totalCost;
      
      return recipe;
    }
    
    // Calculate nutrition facts for a recipe
    function calculateNutritionFacts(ingredients) {
      const allIngredients = getIngredients();
      let totalWeight = 0;
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      let totalCost = 0;
      
      ingredients.forEach(ingredient => {
        // Find the ingredient in the database
        const ingredientData = allIngredients.find(i => 
          i.name.toLowerCase() === ingredient.name.toLowerCase()
        );
        
        if (ingredientData) {
          // Convert to grams if needed
          let weightInGrams = ingredient.quantity;
          if (ingredient.unit === 'ml') {
            // Assume 1ml = 1g for simplicity
            weightInGrams = ingredient.quantity;
          } else if (ingredient.unit === 'pcs') {
            // Use package size as weight per piece
            weightInGrams = ingredient.quantity * ingredientData.packageSize;
          } else if (ingredient.unit === 'tbsp') {
            // Approximate conversion: 1 tbsp = 15g
            weightInGrams = ingredient.quantity * 15;
          } else if (ingredient.unit === 'tsp') {
            // Approximate conversion: 1 tsp = 5g
            weightInGrams = ingredient.quantity * 5;
          }
          
          totalWeight += weightInGrams;
          
          // Calculate nutrition based on 100g values
          const ratio = weightInGrams / 100;
          totalCalories += (ingredientData.calories || 0) * ratio;
          totalProtein += (ingredientData.protein || 0) * ratio;
          totalCarbs += (ingredientData.carbs || 0) * ratio;
          totalFat += (ingredientData.fat || 0) * ratio;
          
          // Calculate cost
          totalCost += ingredientData.pricePerUnit * ingredient.quantity;
        }
      });
      
      return {
        weight: totalWeight,
        calories: totalCalories,
        protein: totalProtein,
        carbs: totalCarbs,
        fat: totalFat,
        cost: totalCost
      };
    }
    
    // Load recipes
    function loadRecipes() {
      const recipes = RecipeDataService.getAllRecipes();
      const container = document.getElementById('recipes-container');
      
      // Clear container
      container.innerHTML = '';
      
      // Add create composite recipe button
      if (AuthService.hasPermission('manage_recipes')) {
        const compositeBtn = document.createElement('button');
        compositeBtn.className = 'btn';
        compositeBtn.textContent = 'Create Composite Recipe';
        compositeBtn.style.marginBottom = '20px';
        compositeBtn.addEventListener('click', openCompositeRecipeModal);
        container.appendChild(compositeBtn);
      }
      
      // Group recipes by category
      const recipesByCategory = {};
      recipes.forEach(recipe => {
        const category = recipe.category || 'other';
        if (!recipesByCategory[category]) {
          recipesByCategory[category] = [];
        }
        recipesByCategory[category].push(recipe);
      });
      
      // Add recipes by category
      Object.keys(recipesByCategory).sort().forEach(category => {
        const categoryHeading = document.createElement('h3');
        categoryHeading.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        container.appendChild(categoryHeading);
        
        const categoryRecipes = recipesByCategory[category];
        const recipeGrid = document.createElement('div');
        recipeGrid.className = 'dashboard-grid';
        
        categoryRecipes.forEach(recipe => {
          const recipeCard = document.createElement('div');
          recipeCard.className = 'dashboard-card';
          
          // Build HTML for recipe card
          let cardHtml = `
            <h3>${recipe.title}</h3>
            <p><span class="recipe-category">${recipe.category || 'Other'}</span></p>
          `;
          
          // Add tags if they exist
          if (recipe.tags && recipe.tags.length > 0) {
            cardHtml += '<p>';
            recipe.tags.forEach(tag => {
              cardHtml += `<span class="recipe-tag">${tag}</span>`;
            });
            cardHtml += '</p>';
          }
          
          // Add difficulty and time
          cardHtml += `
            <p><strong>Difficulty:</strong> ${recipe.difficulty || 'Medium'}</p>
            <p><strong>Time:</strong> ${recipe.time || '60'} minutes</p>
            <p><strong>Cost:</strong> ${recipe.totalCost ? recipe.totalCost.toFixed(3) : '0.000'} KD</p>
          `;
          
          // Add buttons
          cardHtml += `
            <div style="margin-top: 10px;">
              <button class="btn view-recipe-btn" data-id="${recipe.id}">View Recipe</button>
              ${AuthService.hasPermission('manage_recipes') ? 
                `<button class="btn edit-recipe-btn" data-id="${recipe.id}">Edit</button>
                 <button class="btn btn-secondary delete-recipe-btn" data-id="${recipe.id}">Delete</button>` : ''}
            </div>
          `;
          
          recipeCard.innerHTML = cardHtml;
          recipeGrid.appendChild(recipeCard);
        });
        
        container.appendChild(recipeGrid);
      });
      
      // Add event listeners
      document.querySelectorAll('.view-recipe-btn').forEach(btn => {
        btn.addEventListener('click', () => viewRecipe(btn.getAttribute('data-id')));
      });
      
      document.querySelectorAll('.edit-recipe-btn').forEach(btn => {
        btn.addEventListener('click', () => editRecipe(btn.getAttribute('data-id')));
      });
      
      document.querySelectorAll('.delete-recipe-btn').forEach(btn => {
        btn.addEventListener('click', () => deleteRecipe(btn.getAttribute('data-id')));
      });
    }
    
    // View recipe
    function viewRecipe(recipeId) {
      const recipe = RecipeDataService.getRecipeById(recipeId);
      const detailContent = document.getElementById('recipe-detail-content');
      
      // Set title
      document.getElementById('recipe-detail-title').textContent = recipe.title;
      
      // Build HTML for recipe details
      let detailHtml = `
        <p><span class="recipe-category">${recipe.category || 'Other'}</span></p>
      `;
      
      // Add tags if they exist
      if (recipe.tags && recipe.tags.length > 0) {
        detailHtml += '<p>';
        recipe.tags.forEach(tag => {
          detailHtml += `<span class="recipe-tag">${tag}</span>`;
        });
        detailHtml += '</p>';
      }
      
      // Add difficulty and time
      detailHtml += `
        <p><strong>Difficulty:</strong> ${recipe.difficulty || 'Medium'}</p>
        <p><strong>Time:</strong> ${recipe.time || '60'} minutes</p>
      `;
      
      // Add ingredients
      detailHtml += '<h3>Ingredients</h3><ul id="recipe-ingredients-list">';
      recipe.ingredients.forEach(ingredient => {
        detailHtml += `<li>${ingredient.quantity} ${ingredient.unit} ${ingredient.name}</li>`;
      });
      detailHtml += '</ul>';
      
      // Add instructions
      detailHtml += `
        <h3>Instructions</h3>
        <p>${recipe.instructions}</p>
      `;
      
      detailContent.innerHTML = detailHtml;
      
      // Set current recipe for scaling
      window.currentRecipe = recipe;
      window.currentScaleFactor = 1.0;
      window.currentUnitSystem = 'metric';
      
      // Update nutrition facts
      updateNutritionFacts();
      
      // Show modal
      document.getElementById('recipe-detail-modal').style.display = 'block';
    }
    
    // Update nutrition facts in recipe detail view
    function updateNutritionFacts() {
      if (!window.currentRecipe) return;
      
      const recipe = window.currentRecipe;
      const scaleFactor = window.currentScaleFactor;
      
      // Calculate scaled values
      const weight = (recipe.nutritionFacts?.weight || 0) * scaleFactor;
      const calories = (recipe.nutritionFacts?.calories || 0) * scaleFactor;
      const protein = (recipe.nutritionFacts?.protein || 0) * scaleFactor;
      const carbs = (recipe.nutritionFacts?.carbs || 0) * scaleFactor;
      const fat = (recipe.nutritionFacts?.fat || 0) * scaleFactor;
      const cost = (recipe.totalCost || 0) * scaleFactor;
      
      // Update display
      document.getElementById('total-weight').textContent = `${weight.toFixed(1)}g`;
      document.getElementById('total-calories').textContent = `${calories.toFixed(1)} kcal`;
      document.getElementById('total-protein').textContent = `${protein.toFixed(1)}g`;
      document.getElementById('total-carbs').textContent = `${carbs.toFixed(1)}g`;
      document.getElementById('total-fat').textContent = `${fat.toFixed(1)}g`;
      document.getElementById('total-cost').textContent = `${cost.toFixed(3)} KD`;
      
      // Update ingredients list with scaled quantities
      const ingredientsList = document.getElementById('recipe-ingredients-list');
      if (ingredientsList) {
        ingredientsList.innerHTML = '';
        
        recipe.ingredients.forEach(ingredient => {
          const scaledQuantity = ingredient.quantity * scaleFactor;
          const li = document.createElement('li');
          
          if (window.currentUnitSystem === 'metric') {
            li.textContent = `${scaledQuantity.toFixed(1)} ${ingredient.unit} ${ingredient.name}`;
          } else {
            // Convert to imperial
            let imperialQuantity = scaledQuantity;
            let imperialUnit = ingredient.unit;
            
            if (ingredient.unit === 'gram') {
              imperialQuantity = scaledQuantity / 28.35; // Convert to oz
              imperialUnit = 'oz';
            } else if (ingredient.unit === 'ml') {
              imperialQuantity = scaledQuantity / 236.59; // Convert to cups
              imperialUnit = 'cups';
            }
            
            li.textContent = `${imperialQuantity.toFixed(2)} ${imperialUnit} ${ingredient.name}`;
          }
          
          ingredientsList.appendChild(li);
        });
      }
    }
    
    // Calculate loaves
    function calculateLoaves() {
      if (!window.currentRecipe) return;
      
      const recipe = window.currentRecipe;
      const scaleFactor = window.currentScaleFactor;
      const targetWeight = parseFloat(document.getElementById('loaf-weight-input').value);
      
      if (isNaN(targetWeight) || targetWeight <= 0) {
        document.getElementById('loaf-result').textContent = 'Please enter a valid weight.';
        return;
      }
      
      // Calculate total dough weight
      const totalWeight = (recipe.nutritionFacts?.weight || 0) * scaleFactor;
      
      // Estimate weight loss during baking (approximately 15%)
      const bakedWeight = totalWeight * 0.85;
      
      // Calculate number of loaves
      const numberOfLoaves = bakedWeight / targetWeight;
      
      // Update result
      document.getElementById('loaf-result').innerHTML = `
        <p>This recipe will make approximately <strong>${numberOfLoaves.toFixed(1)}</strong> loaves of ${targetWeight}g each.</p>
        <p>Total dough weight: <strong>${totalWeight.toFixed(0)}g</strong></p>
        <p>Estimated baked weight: <strong>${bakedWeight.toFixed(0)}g</strong> (after 15% water loss)</p>
      `;
    }
    
    // Add recipe
    function addRecipe() {
      // Reset form
      document.getElementById('recipe-form').reset();
      document.getElementById('recipe-id').value = '';
      document.getElementById('tags-container').innerHTML = '';
      
      // Reset ingredients container
      const ingredientsContainer = document.getElementById('ingredients-container');
      ingredientsContainer.innerHTML = '';
      addIngredientRow();
      
      // Set form title
      document.getElementById('recipe-form-title').textContent = 'Add New Recipe';
      
      // Show modal
      document.getElementById('recipe-form-modal').style.display = 'block';
      
      // Initialize ingredient dropdowns
      initializeIngredientDropdowns();
    }
    
    // Edit recipe
    function editRecipe(recipeId) {
      const recipe = RecipeDataService.getRecipeById(recipeId);
      
      // Set form values
      document.getElementById('recipe-id').value = recipe.id;
      document.getElementById('recipe-title').value = recipe.title;
      document.getElementById('recipe-category').value = recipe.category || 'other';
      document.getElementById('recipe-difficulty').value = recipe.difficulty || 'medium';
      document.getElementById('recipe-time').value = recipe.time || '60';
      document.getElementById('recipe-instructions').value = recipe.instructions || '';
      
      // Set tags
      const tagsContainer = document.getElementById('tags-container');
      tagsContainer.innerHTML = '';
      
      if (recipe.tags && recipe.tags.length > 0) {
        recipe.tags.forEach(tag => {
          addTagToContainer(tag);
        });
      }
      
      // Set ingredients
      const ingredientsContainer = document.getElementById('ingredients-container');
      ingredientsContainer.innerHTML = '';
      
      if (recipe.ingredients && recipe.ingredients.length > 0) {
        recipe.ingredients.forEach(ingredient => {
          addIngredientRow(ingredient);
        });
      } else {
        addIngredientRow();
      }
      
      // Set form title
      document.getElementById('recipe-form-title').textContent = 'Edit Recipe';
      
      // Show modal
      document.getElementById('recipe-form-modal').style.display = 'block';
      
      // Initialize ingredient dropdowns
      initializeIngredientDropdowns();
      
      // Update nutrition facts
      updateFormNutritionFacts();
    }
    
    // Delete recipe
    function deleteRecipe(recipeId) {
      if (confirm('Are you sure you want to delete this recipe?')) {
        RecipeDataService.deleteRecipe(recipeId);
        loadRecipes();
      }
    }
    
    // Add ingredient row to form
    function addIngredientRow(ingredient = null) {
      const container = document.getElementById('ingredients-container');
      
      const row = document.createElement('div');
      row.className = 'ingredient-row';
      row.style.display = 'flex';
      row.style.gap = '10px';
      row.style.marginBottom = '10px';
      row.style.alignItems = 'center';
      
      const selectContainer = document.createElement('div');
      selectContainer.className = 'ingredient-select-container';
      selectContainer.style.flexGrow = '1';
      
      const select = document.createElement('input');
      select.type = 'text';
      select.className = 'ingredient-select';
      select.placeholder = 'Search for an ingredient...';
      if (ingredient) {
        select.value = ingredient.name;
        select.dataset.selected = 'true';
      }
      
      const dropdown = document.createElement('div');
      dropdown.className = 'ingredient-dropdown';
      
      selectContainer.appendChild(select);
      selectContainer.appendChild(dropdown);
      
      const quantity = document.createElement('input');
      quantity.type = 'number';
      quantity.className = 'ingredient-quantity';
      quantity.placeholder = 'Qty';
      quantity.min = '0';
      quantity.step = '0.1';
      if (ingredient) {
        quantity.value = ingredient.quantity;
      }
      
      const unit = document.createElement('select');
      unit.className = 'ingredient-unit';
      
      const units = ['gram', 'ml', 'pcs', 'tbsp', 'tsp'];
      units.forEach(u => {
        const option = document.createElement('option');
        option.value = u;
        option.textContent = u;
        unit.appendChild(option);
      });
      
      if (ingredient) {
        unit.value = ingredient.unit;
      }
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-secondary remove-ingredient-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', function() {
        row.remove();
        updateFormNutritionFacts();
      });
      
      row.appendChild(selectContainer);
      row.appendChild(quantity);
      row.appendChild(unit);
      row.appendChild(removeBtn);
      
      container.appendChild(row);
      
      // Add event listeners for quantity and unit changes
      quantity.addEventListener('input', updateFormNutritionFacts);
      unit.addEventListener('change', updateFormNutritionFacts);
      
      return row;
    }
    
    // Initialize ingredient dropdowns
    function initializeIngredientDropdowns() {
      const ingredients = getIngredients();
      
      document.querySelectorAll('.ingredient-select').forEach(select => {
        const dropdown = select.nextElementSibling;
        
        // Add event listener for input
        select.addEventListener('input', function() {
          const query = this.value.toLowerCase();
          
          // Filter ingredients
          const filteredIngredients = ingredients.filter(ingredient => 
            ingredient.name.toLowerCase().includes(query)
          );
          
          // Clear dropdown
          dropdown.innerHTML = '';
          
          // Add filtered ingredients to dropdown
          filteredIngredients.slice(0, 10).forEach(ingredient => {
            const item = document.createElement('div');
            item.className = 'ingredient-dropdown-item';
            item.textContent = ingredient.name;
            item.addEventListener('click', function() {
              select.value = ingredient.name;
              select.dataset.selected = 'true';
              dropdown.style.display = 'none';
              updateFormNutritionFacts();
            });
            dropdown.appendChild(item);
          });
          
          // Show dropdown if there are items
          if (filteredIngredients.length > 0) {
            dropdown.style.display = 'block';
          } else {
            dropdown.style.display = 'none';
          }
        });
        
        // Add event listener for focus
        select.addEventListener('focus', function() {
          if (this.value) {
            const event = new Event('input');
            this.dispatchEvent(event);
          }
        });
        
        // Add event listener for blur
        select.addEventListener('blur', function() {
          // Delay hiding dropdown to allow for clicks
          setTimeout(() => {
            dropdown.style.display = 'none';
          }, 200);
        });
      });
    }
    
    // Update form nutrition facts
    function updateFormNutritionFacts() {
      const ingredients = [];
      
      document.querySelectorAll('.ingredient-row').forEach(row => {
        const nameInput = row.querySelector('.ingredient-select');
        const quantityInput = row.querySelector('.ingredient-quantity');
        const unitSelect = row.querySelector('.ingredient-unit');
        
        if (nameInput.value && quantityInput.value) {
          ingredients.push({
            name: nameInput.value,
            quantity: parseFloat(quantityInput.value),
            unit: unitSelect.value
          });
        }
      });
      
      const nutrition = calculateNutritionFacts(ingredients);
      
      // Update display
      document.getElementById('form-total-weight').textContent = `${nutrition.weight.toFixed(1)}g`;
      document.getElementById('form-total-calories').textContent = `${nutrition.calories.toFixed(1)} kcal`;
      document.getElementById('form-total-protein').textContent = `${nutrition.protein.toFixed(1)}g`;
      document.getElementById('form-total-carbs').textContent = `${nutrition.carbs.toFixed(1)}g`;
      document.getElementById('form-total-fat').textContent = `${nutrition.fat.toFixed(1)}g`;
      document.getElementById('form-total-cost').textContent = `${nutrition.cost.toFixed(3)} KD`;
    }
    
    // Add tag to container
    function addTagToContainer(tag) {
      const tagsContainer = document.getElementById('tags-container');
      
      const tagElement = document.createElement('div');
      tagElement.className = 'recipe-tag';
      tagElement.style.display = 'flex';
      tagElement.style.alignItems = 'center';
      tagElement.style.gap = '5px';
      
      const tagText = document.createElement('span');
      tagText.textContent = tag;
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.textContent = '';
      removeBtn.style.border = 'none';
      removeBtn.style.background = 'none';
      removeBtn.style.cursor = 'pointer';
      removeBtn.style.padding = '0 5px';
      removeBtn.addEventListener('click', function() {
        tagElement.remove();
      });
      
      tagElement.appendChild(tagText);
      tagElement.appendChild(removeBtn);
      
      tagsContainer.appendChild(tagElement);
    }
    
    // Open composite recipe modal
    function openCompositeRecipeModal() {
      // Reset form
      document.getElementById('composite-recipe-form').reset();
      
      // Reset component recipes container
      const componentContainer = document.getElementById('component-recipes-container');
      componentContainer.innerHTML = '';
      addComponentRow();
      
      // Reset ingredients container
      const ingredientsContainer = document.getElementById('composite-ingredients-container');
      ingredientsContainer.innerHTML = '';
      addCompositeIngredientRow();
      
      // Show modal
      document.getElementById('composite-recipe-modal').style.display = 'block';
      
      // Initialize ingredient dropdowns
      initializeCompositeIngredientDropdowns();
      
      // Initialize component recipe dropdowns
      initializeComponentRecipeDropdowns();
    }
    
    // Add component recipe row
    function addComponentRow() {
      const container = document.getElementById('component-recipes-container');
      
      const row = document.createElement('div');
      row.className = 'component-recipe-row';
      row.style.display = 'flex';
      row.style.gap = '10px';
      row.style.marginBottom = '10px';
      row.style.alignItems = 'center';
      
      const select = document.createElement('select');
      select.className = 'component-recipe-select';
      select.style.flexGrow = '1';
      
      // Add empty option
      const emptyOption = document.createElement('option');
      emptyOption.value = '';
      emptyOption.textContent = 'Select a recipe...';
      select.appendChild(emptyOption);
      
      // Add recipes
      const recipes = RecipeDataService.getAllRecipes();
      recipes.forEach(recipe => {
        const option = document.createElement('option');
        option.value = recipe.id;
        option.textContent = recipe.title;
        select.appendChild(option);
      });
      
      const quantity = document.createElement('input');
      quantity.type = 'number';
      quantity.className = 'component-recipe-quantity';
      quantity.placeholder = 'Qty';
      quantity.min = '1';
      quantity.value = '1';
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-secondary remove-component-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', function() {
        row.remove();
        updateCompositeNutritionFacts();
      });
      
      row.appendChild(select);
      row.appendChild(quantity);
      row.appendChild(removeBtn);
      
      container.appendChild(row);
      
      // Add event listeners
      select.addEventListener('change', updateCompositeNutritionFacts);
      quantity.addEventListener('input', updateCompositeNutritionFacts);
      
      return row;
    }
    
    // Add composite ingredient row
    function addCompositeIngredientRow() {
      const container = document.getElementById('composite-ingredients-container');
      
      const row = document.createElement('div');
      row.className = 'ingredient-row';
      row.style.display = 'flex';
      row.style.gap = '10px';
      row.style.marginBottom = '10px';
      row.style.alignItems = 'center';
      
      const selectContainer = document.createElement('div');
      selectContainer.className = 'ingredient-select-container';
      selectContainer.style.flexGrow = '1';
      
      const select = document.createElement('input');
      select.type = 'text';
      select.className = 'ingredient-select';
      select.placeholder = 'Search for an ingredient...';
      
      const dropdown = document.createElement('div');
      dropdown.className = 'ingredient-dropdown';
      
      selectContainer.appendChild(select);
      selectContainer.appendChild(dropdown);
      
      const quantity = document.createElement('input');
      quantity.type = 'number';
      quantity.className = 'ingredient-quantity';
      quantity.placeholder = 'Qty';
      quantity.min = '0';
      quantity.step = '0.1';
      
      const unit = document.createElement('select');
      unit.className = 'ingredient-unit';
      
      const units = ['gram', 'ml', 'pcs', 'tbsp', 'tsp'];
      units.forEach(u => {
        const option = document.createElement('option');
        option.value = u;
        option.textContent = u;
        unit.appendChild(option);
      });
      
      const removeBtn = document.createElement('button');
      removeBtn.type = 'button';
      removeBtn.className = 'btn btn-secondary remove-ingredient-btn';
      removeBtn.textContent = 'Remove';
      removeBtn.addEventListener('click', function() {
        row.remove();
        updateCompositeNutritionFacts();
      });
      
      row.appendChild(selectContainer);
      row.appendChild(quantity);
      row.appendChild(unit);
      row.appendChild(removeBtn);
      
      container.appendChild(row);
      
      // Add event listeners
      quantity.addEventListener('input', updateCompositeNutritionFacts);
      unit.addEventListener('change', updateCompositeNutritionFacts);
      
      return row;
    }
    
    // Initialize composite ingredient dropdowns
    function initializeCompositeIngredientDropdowns() {
      const ingredients = getIngredients();
      
      document.querySelectorAll('#composite-ingredients-container .ingredient-select').forEach(select => {
        const dropdown = select.nextElementSibling;
        
        // Add event listener for input
        select.addEventListener('input', function() {
          const query = this.value.toLowerCase();
          
          // Filter ingredients
          const filteredIngredients = ingredients.filter(ingredient => 
            ingredient.name.toLowerCase().includes(query)
          );
          
          // Clear dropdown
          dropdown.innerHTML = '';
          
          // Add filtered ingredients to dropdown
          filteredIngredients.slice(0, 10).forEach(ingredient => {
            const item = document.createElement('div');
            item.className = 'ingredient-dropdown-item';
            item.textContent = ingredient.name;
            item.addEventListener('click', function() {
              select.value = ingredient.name;
              select.dataset.selected = 'true';
              dropdown.style.display = 'none';
              updateCompositeNutritionFacts();
            });
            dropdown.appendChild(item);
          });
          
          // Show dropdown if there are items
          if (filteredIngredients.length > 0) {
            dropdown.style.display = 'block';
          } else {
            dropdown.style.display = 'none';
          }
        });
        
        // Add event listener for focus
        select.addEventListener('focus', function() {
          if (this.value) {
            const event = new Event('input');
            this.dispatchEvent(event);
          }
        });
        
        // Add event listener for blur
        select.addEventListener('blur', function() {
          // Delay hiding dropdown to allow for clicks
          setTimeout(() => {
            dropdown.style.display = 'none';
          }, 200);
        });
      });
    }
    
    // Initialize component recipe dropdowns
    function initializeComponentRecipeDropdowns() {
      // Nothing special needed here, just using standard select elements
    }
    
    // Update composite nutrition facts
    function updateCompositeNutritionFacts() {
      let totalWeight = 0;
      let totalCalories = 0;
      let totalProtein = 0;
      let totalCarbs = 0;
      let totalFat = 0;
      let totalCost = 0;
      
      // Calculate nutrition from component recipes
      document.querySelectorAll('.component-recipe-row').forEach(row => {
        const recipeSelect = row.querySelector('.component-recipe-select');
        const quantityInput = row.querySelector('.component-recipe-quantity');
        
        if (recipeSelect.value && quantityInput.value) {
          const recipe = RecipeDataService.getRecipeById(recipeSelect.value);
          const quantity = parseInt(quantityInput.value);
          
          if (recipe) {
            totalWeight += (recipe.nutritionFacts?.weight || 0) * quantity;
            totalCalories += (recipe.nutritionFacts?.calories || 0) * quantity;
            totalProtein += (recipe.nutritionFacts?.protein || 0) * quantity;
            totalCarbs += (recipe.nutritionFacts?.carbs || 0) * quantity;
            totalFat += (recipe.nutritionFacts?.fat || 0) * quantity;
            totalCost += (recipe.totalCost || 0) * quantity;
          }
        }
      });
      
      // Calculate nutrition from additional ingredients
      const additionalIngredients = [];
      
      document.querySelectorAll('#composite-ingredients-container .ingredient-row').forEach(row => {
        const nameInput = row.querySelector('.ingredient-select');
        const quantityInput = row.querySelector('.ingredient-quantity');
        const unitSelect = row.querySelector('.ingredient-unit');
        
        if (nameInput.value && quantityInput.value) {
          additionalIngredients.push({
            name: nameInput.value,
            quantity: parseFloat(quantityInput.value),
            unit: unitSelect.value
          });
        }
      });
      
      const additionalNutrition = calculateNutritionFacts(additionalIngredients);
      
      totalWeight += additionalNutrition.weight;
      totalCalories += additionalNutrition.calories;
      totalProtein += additionalNutrition.protein;
      totalCarbs += additionalNutrition.carbs;
      totalFat += additionalNutrition.fat;
      totalCost += additionalNutrition.cost;
      
      // Update display
      document.getElementById('composite-total-weight').textContent = `${totalWeight.toFixed(1)}g`;
      document.getElementById('composite-total-calories').textContent = `${totalCalories.toFixed(1)} kcal`;
      document.getElementById('composite-total-protein').textContent = `${totalProtein.toFixed(1)}g`;
      document.getElementById('composite-total-carbs').textContent = `${totalCarbs.toFixed(1)}g`;
      document.getElementById('composite-total-fat').textContent = `${totalFat.toFixed(1)}g`;
      document.getElementById('composite-total-cost').textContent = `${totalCost.toFixed(3)} KD`;
    }
    
    // Show duplicate confirmation modal
    function showDuplicateConfirmation(duplicates, recipes) {
      const duplicateList = document.getElementById('duplicate-list');
      duplicateList.innerHTML = '';
      
      duplicates.forEach(dup => {
        const item = document.createElement('div');
        item.className = 'duplicate-item';
        item.innerHTML = `
          <h3>${dup.new.title}</h3>
          <p>This recipe already exists. Would you like to replace it?</p>
        `;
        duplicateList.appendChild(item);
      });
      
      // Store data for later use
      window.pendingImport = {
        duplicates: duplicates,
        recipes: recipes
      };
      
      // Show modal
      document.getElementById('duplicate-confirmation-modal').style.display = 'block';
    }
    
    // Add recipe button
    document.getElementById('add-recipe-btn').addEventListener('click', addRecipe);
    
    // Add ingredient row button
    document.getElementById('add-ingredient-row-btn').addEventListener('click', function() {
      const row = addIngredientRow();
      initializeIngredientDropdowns();
    });
    
    // Add component button
    document.getElementById('add-component-btn').addEventListener('click', function() {
      const row = addComponentRow();
    });
    
    // Add composite ingredient button
    document.getElementById('add-composite-ingredient-btn').addEventListener('click', function() {
      const row = addCompositeIngredientRow();
      initializeCompositeIngredientDropdowns();
    });
    
    // Add tag button
    document.getElementById('add-tag-btn').addEventListener('click', function() {
      const tagInput = document.getElementById('tag-input');
      const tag = tagInput.value.trim();
      
      if (tag) {
        addTagToContainer(tag);
        tagInput.value = '';
      }
    });
    
    // Cancel recipe form button
    document.getElementById('cancel-recipe-btn').addEventListener('click', () => {
      document.getElementById('recipe-form-modal').style.display = 'none';
    });
    
    // Cancel composite recipe form button
    document.getElementById('cancel-composite-btn').addEventListener('click', () => {
      document.getElementById('composite-recipe-modal').style.display = 'none';
    });
    
    // Close detail button
    document.getElementById('close-detail-btn').addEventListener('click', () => {
      document.getElementById('recipe-detail-modal').style.display = 'none';
    });
    
    // Recipe form submission
    document.getElementById('recipe-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const recipeId = document.getElementById('recipe-id').value;
      
      // Get tags
      const tags = [];
      document.querySelectorAll('#tags-container .recipe-tag span').forEach(tagSpan => {
        tags.push(tagSpan.textContent);
      });
      
      // Get ingredients
      const ingredients = [];
      document.querySelectorAll('.ingredient-row').forEach(row => {
        const nameInput = row.querySelector('.ingredient-select');
        const quantityInput = row.querySelector('.ingredient-quantity');
        const unitSelect = row.querySelector('.ingredient-unit');
        
        if (nameInput.value && quantityInput.value) {
          ingredients.push({
            name: nameInput.value,
            quantity: parseFloat(quantityInput.value),
            unit: unitSelect.value
          });
        }
      });
      
      // Calculate nutrition facts
      const nutrition = calculateNutritionFacts(ingredients);
      
      const recipeData = {
        title: document.getElementById('recipe-title').value,
        category: document.getElementById('recipe-category').value,
        difficulty: document.getElementById('recipe-difficulty').value,
        time: parseInt(document.getElementById('recipe-time').value),
        tags: tags,
        ingredients: ingredients,
        instructions: document.getElementById('recipe-instructions').value,
        nutritionFacts: {
          weight: nutrition.weight,
          calories: nutrition.calories,
          protein: nutrition.protein,
          carbs: nutrition.carbs,
          fat: nutrition.fat
        },
        totalCost: nutrition.cost
      };
      
      if (recipeId) {
        // Update existing recipe
        RecipeDataService.updateRecipe(recipeId, recipeData);
      } else {
        // Create new recipe
        RecipeDataService.createRecipe(recipeData);
      }
      
      // Close modal
      document.getElementById('recipe-form-modal').style.display = 'none';
      
      // Reload recipes
      loadRecipes();
    });
    
    // Composite recipe form submission
    document.getElementById('composite-recipe-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      // Get component recipes
      const componentRecipes = [];
      document.querySelectorAll('.component-recipe-row').forEach(row => {
        const recipeSelect = row.querySelector('.component-recipe-select');
        const quantityInput = row.querySelector('.component-recipe-quantity');
        
        if (recipeSelect.value && quantityInput.value) {
          componentRecipes.push({
            recipeId: recipeSelect.value,
            quantity: parseInt(quantityInput.value)
          });
        }
      });
      
      // Get additional ingredients
      const additionalIngredients = [];
      document.querySelectorAll('#composite-ingredients-container .ingredient-row').forEach(row => {
        const nameInput = row.querySelector('.ingredient-select');
        const quantityInput = row.querySelector('.ingredient-quantity');
        const unitSelect = row.querySelector('.ingredient-unit');
        
        if (nameInput.value && quantityInput.value) {
          additionalIngredients.push({
            name: nameInput.value,
            quantity: parseFloat(quantityInput.value),
            unit: unitSelect.value
          });
        }
      });
      
      // Build combined ingredients list
      const allIngredients = [];
      
      // Add ingredients from component recipes
      componentRecipes.forEach(component => {
        const recipe = RecipeDataService.getRecipeById(component.recipeId);
        if (recipe && recipe.ingredients) {
          recipe.ingredients.forEach(ingredient => {
            // Check if ingredient already exists in the list
            const existingIngredient = allIngredients.find(i => i.name === ingredient.name && i.unit === ingredient.unit);
            
            if (existingIngredient) {
              // Add to existing ingredient
              existingIngredient.quantity += ingredient.quantity * component.quantity;
            } else {
              // Add as new ingredient
              allIngredients.push({
                name: ingredient.name,
                quantity: ingredient.quantity * component.quantity,
                unit: ingredient.unit
              });
            }
          });
        }
      });
      
      // Add additional ingredients
      additionalIngredients.forEach(ingredient => {
        // Check if ingredient already exists in the list
        const existingIngredient = allIngredients.find(i => i.name === ingredient.name && i.unit === ingredient.unit);
        
        if (existingIngredient) {
          // Add to existing ingredient
          existingIngredient.quantity += ingredient.quantity;
        } else {
          // Add as new ingredient
          allIngredients.push({
            name: ingredient.name,
            quantity: ingredient.quantity,
            unit: ingredient.unit
          });
        }
      });
      
      // Calculate nutrition facts
      const nutrition = calculateNutritionFacts(allIngredients);
      
      // Build instructions
      let instructions = document.getElementById('composite-recipe-instructions').value;
      
      // Add component recipe details to instructions
      if (componentRecipes.length > 0) {
        instructions = 'Component Recipes:\n\n' + componentRecipes.map(component => {
          const recipe = RecipeDataService.getRecipeById(component.recipeId);
          return `- ${component.quantity}x ${recipe.title}`;
        }).join('\n') + '\n\n' + instructions;
      }
      
      const recipeData = {
        title: document.getElementById('composite-recipe-title').value,
        category: document.getElementById('composite-recipe-category').value,
        difficulty: 'medium',
        time: 30, // Default time for composite recipes
        tags: ['composite'],
        ingredients: allIngredients,
        instructions: instructions,
        nutritionFacts: {
          weight: nutrition.weight,
          calories: nutrition.calories,
          protein: nutrition.protein,
          carbs: nutrition.carbs,
          fat: nutrition.fat
        },
        totalCost: nutrition.cost,
        isComposite: true,
        componentRecipes: componentRecipes
      };
      
      // Create new recipe
      RecipeDataService.createRecipe(recipeData);
      
      // Close modal
      document.getElementById('composite-recipe-modal').style.display = 'none';
      
      // Reload recipes
      loadRecipes();
    });
    
    // CSV Upload functionality
    document.getElementById('upload-csv-btn').addEventListener('click', () => {
      const fileInput = document.getElementById('csv-file-input');
      const resultDiv = document.getElementById('upload-result');
      
      if (!fileInput.files || fileInput.files.length === 0) {
        resultDiv.className = 'upload-result upload-error';
        resultDiv.textContent = 'Please select a CSV file to upload.';
        resultDiv.style.display = 'block';
        return;
      }
      
      const file = fileInput.files[0];
      if (file.type !== 'text/csv' && !file.name.endsWith('.csv')) {
        resultDiv.className = 'upload-result upload-error';
        resultDiv.textContent = 'Please select a valid CSV file.';
        resultDiv.style.display = 'block';
        return;
      }
      
      const reader = new FileReader();
      reader.onload = (e) => {
        const csvData = e.target.result;
        const result = RecipeDataService.importRecipesFromCSV(csvData);
        
        if (result.success) {
          if (result.duplicates) {
            // Show duplicate confirmation modal
            showDuplicateConfirmation(result.duplicates, result.recipes);
          } else {
            resultDiv.className = 'upload-result upload-success';
            resultDiv.textContent = result.message;
            resultDiv.style.display = 'block';
            
            // Reload recipes
            loadRecipes();
          }
        } else {
          resultDiv.className = 'upload-result upload-error';
          resultDiv.textContent = result.message;
          resultDiv.style.display = 'block';
        }
      };
      
      reader.onerror = () => {
        resultDiv.className = 'upload-result upload-error';
        resultDiv.textContent = 'Error reading the CSV file.';
        resultDiv.style.display = 'block';
      };
      
      reader.readAsText(file);
    });
    
    // Replace all button
    document.getElementById('replace-all-btn').addEventListener('click', () => {
      if (window.pendingImport) {
        const { duplicates, recipes } = window.pendingImport;
        
        // Add new recipes
        RecipeDataService.recipes = [...RecipeDataService.recipes, ...recipes];
        
        // Replace duplicates
        duplicates.forEach(dup => {
          const index = RecipeDataService.recipes.findIndex(r => r.title.toLowerCase() === dup.existing.title.toLowerCase());
          if (index !== -1) {
            RecipeDataService.recipes[index] = dup.new;
          }
        });
        
        RecipeDataService.saveRecipes();
        
        // Hide modal
        document.getElementById('duplicate-confirmation-modal').style.display = 'none';
        
        // Show success message
        const resultDiv = document.getElementById('upload-result');
        resultDiv.className = 'upload-result upload-success';
        resultDiv.textContent = `Successfully imported ${recipes.length} recipes and replaced ${duplicates.length} existing recipes.`;
        resultDiv.style.display = 'block';
        
        // Reload recipes
        loadRecipes();
        
        // Clear pending import
        window.pendingImport = null;
      }
    });
    
    // Keep all button
    document.getElementById('keep-all-btn').addEventListener('click', () => {
      if (window.pendingImport) {
        const { duplicates, recipes } = window.pendingImport;
        
        // Add only new recipes
        RecipeDataService.recipes = [...RecipeDataService.recipes, ...recipes];
        RecipeDataService.saveRecipes();
        
        // Hide modal
        document.getElementById('duplicate-confirmation-modal').style.display = 'none';
        
        // Show success message
        const resultDiv = document.getElementById('upload-result');
        resultDiv.className = 'upload-result upload-success';
        resultDiv.textContent = `Successfully imported ${recipes.length} recipes. Kept ${duplicates.length} existing recipes.`;
        resultDiv.style.display = 'block';
        
        // Reload recipes
        loadRecipes();
        
        // Clear pending import
        window.pendingImport = null;
      }
    });
    
    // Cancel import button
    document.getElementById('cancel-import-btn').addEventListener('click', () => {
      // Hide modal
      document.getElementById('duplicate-confirmation-modal').style.display = 'none';
      
      // Show cancel message
      const resultDiv = document.getElementById('upload-result');
      resultDiv.className = 'upload-result upload-error';
      resultDiv.textContent = 'Import cancelled.';
      resultDiv.style.display = 'block';
      
      // Clear pending import
      window.pendingImport = null;
    });
    
    // Scale down button
    document.getElementById('scale-down-btn').addEventListener('click', () => {
      let factor = parseFloat(document.getElementById('scale-factor-input').value);
      factor = Math.max(0.1, factor - 0.1);
      document.getElementById('scale-factor-input').value = factor.toFixed(1);
      window.currentScaleFactor = factor;
      updateNutritionFacts();
    });
    
    // Scale up button
    document.getElementById('scale-up-btn').addEventListener('click', () => {
      let factor = parseFloat(document.getElementById('scale-factor-input').value);
      factor = factor + 0.1;
      document.getElementById('scale-factor-input').value = factor.toFixed(1);
      window.currentScaleFactor = factor;
      updateNutritionFacts();
    });
    
    // Apply scale button
    document.getElementById('apply-scale-btn').addEventListener('click', () => {
      let factor = parseFloat(document.getElementById('scale-factor-input').value);
      if (isNaN(factor) || factor < 0.1) {
        alert('Please enter a valid scaling factor (minimum 0.1)');
        document.getElementById('scale-factor-input').value = window.currentScaleFactor.toFixed(1);
        return;
      }
      window.currentScaleFactor = factor;
      updateNutritionFacts();
    });
    
    // Reset scale button
    document.getElementById('reset-scale-btn').addEventListener('click', () => {
      document.getElementById('scale-factor-input').value = "1.0";
      window.currentScaleFactor = 1.0;
      updateNutritionFacts();
    });
    
    // Calculate loaves button
    document.getElementById('calculate-loaves-btn').addEventListener('click', calculateLoaves);
    
    // Unit conversion buttons
    document.getElementById('convert-metric-btn').addEventListener('click', () => {
      window.currentUnitSystem = 'metric';
      updateNutritionFacts();
    });
    
    document.getElementById('convert-imperial-btn').addEventListener('click', () => {
      window.currentUnitSystem = 'imperial';
      updateNutritionFacts();
    });
    
    // Scale factor input change
    document.getElementById('scale-factor-input').addEventListener('change', () => {
      let factor = parseFloat(document.getElementById('scale-factor-input').value);
      if (isNaN(factor) || factor < 0.1) {
        alert('Please enter a valid scaling factor (minimum 0.1)');
        document.getElementById('scale-factor-input').value = window.currentScaleFactor.toFixed(1);
        return;
      }
      window.currentScaleFactor = factor;
      updateNutritionFacts();
    });
    
    // Load recipes on page load
    loadRecipes();
  </script>
</body>
</html>
